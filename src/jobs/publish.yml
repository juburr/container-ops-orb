description: |
  Publish a container image to a registry with optional signing and SBOM generation.

  This job loads an archived image from a previous build job, tags it for the
  target registry, pushes it, and optionally:
  - Signs the image with Cosign (key-based)
  - Generates an SBOM with Syft
  - Attests the SBOM to the image

  Designed to work with the build job in a build-once, publish-many workflow.

executor: << parameters.executor >>

parameters:
  # === EXECUTOR CONFIGURATION ===
  executor:
    type: executor
    default: default
    description: |
      The executor to use for the publish job. Defaults to a machine executor
      with Docker pre-installed. The machine executor is recommended as it
      provides native Docker support without requiring setup_remote_docker.

  # === IMAGE CONFIGURATION ===
  image:
    type: string
    description: |
      (Required) The local image name from the build job. This should match
      the image name used when building and archiving. Example: "myapp"

  tag:
    type: string
    default: "${CIRCLE_SHA1}"
    description: |
      The primary tag of the archived image to load. This is typically the
      commit SHA or a version tag. Supports environment variable substitution.

  additional_tags:
    type: string
    default: ""
    description: |
      Additional tags to apply when pushing (space-separated).
      These tags are applied in addition to the primary tag.
      Example: "latest v1.0.0"

  # === REGISTRY CONFIGURATION ===
  registry:
    type: string
    description: |
      (Required) Container registry hostname to push to.
      Examples: "ghcr.io", "docker.io", "gcr.io", "123456789.dkr.ecr.us-east-1.amazonaws.com"

  registry_namespace:
    type: string
    description: |
      (Required) Registry namespace or organization path.
      Combined with registry and image name to form the full image path.
      Example: "myorg" results in "ghcr.io/myorg/myapp"

  registry_username:
    type: env_var_name
    default: DOCKER_USERNAME
    description: |
      Name of the environment variable containing the registry username.

  registry_password:
    type: env_var_name
    default: DOCKER_PASSWORD
    description: |
      Name of the environment variable containing the registry password
      or access token.

  # === WORKSPACE CONFIGURATION ===
  attach_workspace:
    type: boolean
    default: true
    description: |
      Attach a workspace from a previous job to access the archived image.
      Set to false if the image is already available locally.

  attach_workspace_at:
    type: string
    default: "~"
    description: |
      Path where the workspace should be attached.

  archive_path:
    type: string
    default: "~/images"
    description: |
      Directory path where the archived image tar is located.
      Should match the archive_path used in the build job.

  # === TAG FILE SUPPORT (tagger orb integration) ===
  tags_file:
    type: string
    default: ""
    description: |
      Path to a tags file generated by the container-tagger-orb.
      When set, the tagger orb commands are used instead of docker_tag/docker_push.
      Each line in the file should contain one tag.
      Example: "~/workspace/tags.txt"

  # === SIGNING CONFIGURATION ===
  sign:
    type: boolean
    default: false
    description: |
      Enable image signing with Cosign using key-based signing.
      Requires cosign_private_key and cosign_password to be set.

  cosign_version:
    type: string
    default: "2.4.0"
    description: |
      Version of Cosign to install for signing operations.

  cosign_private_key:
    type: env_var_name
    default: COSIGN_PRIVATE_KEY
    description: |
      Name of the environment variable containing the base64-encoded
      Cosign private key for signing.

  cosign_password:
    type: env_var_name
    default: COSIGN_PASSWORD
    description: |
      Name of the environment variable containing the password
      for the Cosign private key.

  cosign_public_key:
    type: env_var_name
    default: COSIGN_PUBLIC_KEY
    description: |
      Name of the environment variable containing the base64-encoded
      Cosign public key for signature verification.

  verify_signature:
    type: boolean
    default: true
    description: |
      Verify the signature after signing. Requires cosign_public_key to be set.
      Only applies when sign is true.

  # === SBOM CONFIGURATION ===
  sbom:
    type: boolean
    default: false
    description: |
      Enable SBOM (Software Bill of Materials) generation with Syft.

  sbom_format:
    type: enum
    enum: ["spdx-json", "cyclonedx-json"]
    default: "spdx-json"
    description: |
      Output format for the generated SBOM.
      - spdx-json: SPDX 2.3 JSON format
      - cyclonedx-json: CycloneDX 1.4 JSON format

  syft_version:
    type: string
    default: "1.11.0"
    description: |
      Version of Syft to install for SBOM generation.

  log_sbom:
    type: boolean
    default: false
    description: |
      Output the generated SBOM to the job logs.

  # === ATTESTATION CONFIGURATION ===
  attest:
    type: boolean
    default: false
    description: |
      Attest the SBOM to the image using Cosign.
      Requires both sign=true and sbom=true to be enabled.

  verify_attestation:
    type: boolean
    default: true
    description: |
      Verify the attestation after attesting. Requires cosign_public_key to be set.
      Only applies when attest is true.

  # === WORKFLOW CUSTOMIZATION ===
  pre_steps:
    type: steps
    default: []
    description: |
      Steps to execute before the publish process begins. Runs after
      workspace attachment but before registry login.

  post_steps:
    type: steps
    default: []
    description: |
      Steps to execute after the publish process completes. Runs after
      all signing/SBOM/attestation steps but before registry logout.

steps:
  # 1. Workspace attachment (conditional)
  - when:
      condition: << parameters.attach_workspace >>
      steps:
        - attach_workspace:
            at: << parameters.attach_workspace_at >>

  # 2. Pre-steps hook (user customization)
  - steps: << parameters.pre_steps >>

  # 3. Registry login
  - docker_login:
      registry: << parameters.registry >>
      username: << parameters.registry_username >>
      password: << parameters.registry_password >>

  # 4. Load archived image
  - docker_load:
      image: << parameters.image >>
      archive_path: << parameters.archive_path >>

  # 5a. Tag and push using tagger orb (when tags_file is provided)
  - when:
      condition: << parameters.tags_file >>
      steps:
        - tagger/tag:
            source_image: << parameters.image >>:<< parameters.tag >>
            target_image: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>
            tags_file: << parameters.tags_file >>
        - tagger/push:
            target_image: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>
            tags_file: << parameters.tags_file >>
        - tagger/populate_tag

  # 5b. Tag and push using docker commands (when tags_file is not provided)
  - unless:
      condition: << parameters.tags_file >>
      steps:
        - docker_tag:
            source_image: << parameters.image >>:<< parameters.tag >>
            target_image: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>
            tags: << parameters.tag >> << parameters.additional_tags >>
        - docker_push:
            image: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>
            tags: << parameters.tag >> << parameters.additional_tags >>

  # 6. Signing with Cosign (conditional)
  - when:
      condition: << parameters.sign >>
      steps:
        # 6a. Install Cosign
        - cosign/install:
            version: << parameters.cosign_version >>
            caching: true
        # 6b. Sign image
        - cosign/sign_image:
            image: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>:<< parameters.tag >>
            private_key: << parameters.cosign_private_key >>
            password: << parameters.cosign_password >>
        # 6c. Verify signature (conditional)
        - when:
            condition: << parameters.verify_signature >>
            steps:
              - cosign/verify_image:
                  image: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>:<< parameters.tag >>
                  public_key: << parameters.cosign_public_key >>

  # 7. SBOM generation with Syft (conditional)
  - when:
      condition: << parameters.sbom >>
      steps:
        # 7a. Install Syft
        - syft/install:
            version: << parameters.syft_version >>
            caching: true
        # 7b. Generate SBOM
        - syft/generate_sbom:
            source: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>:<< parameters.tag >>
            output_formats: << parameters.sbom_format >>
            output_dir: sboms
        # 7c. Log SBOM (conditional)
        - when:
            condition: << parameters.log_sbom >>
            steps:
              - run:
                  name: Display SBOM
                  command: |
                    echo "Generated SBOM:"
                    cat sboms/*

  # 8. SBOM attestation (conditional - requires sign=true and sbom=true)
  - when:
      condition:
        and:
          - << parameters.attest >>
          - << parameters.sign >>
          - << parameters.sbom >>
      steps:
        # 8a. Attest SBOM
        - run:
            name: Determine SBOM path and attest
            environment:
              PARAM_IMAGE: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>:<< parameters.tag >>
              PARAM_SBOM_FORMAT: << parameters.sbom_format >>
              PARAM_PRIVATE_KEY: << parameters.cosign_private_key >>
              PARAM_PASSWORD: << parameters.cosign_password >>
            command: |
              #!/bin/bash
              set -euo pipefail

              # Determine SBOM file path based on format
              if [ "${PARAM_SBOM_FORMAT}" = "spdx-json" ]; then
                SBOM_FILE=$(ls sboms/*.spdx.json 2>/dev/null | head -1)
                PREDICATE_TYPE="spdxjson"
              else
                SBOM_FILE=$(ls sboms/*.cdx.json 2>/dev/null | head -1)
                PREDICATE_TYPE="cyclonedx"
              fi

              if [ -z "${SBOM_FILE}" ]; then
                echo "ERROR: No SBOM file found in sboms/ directory"
                exit 1
              fi

              echo "Attesting SBOM to image..."
              echo "  Image: ${PARAM_IMAGE}"
              echo "  SBOM: ${SBOM_FILE}"
              echo "  Predicate Type: ${PREDICATE_TYPE}"

              # Export for subsequent cosign/attest command
              {
                echo "export SBOM_FILE='${SBOM_FILE}'"
                echo "export PREDICATE_TYPE='${PREDICATE_TYPE}'"
              } >> "${BASH_ENV}"
        - cosign/attest:
            image: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>:<< parameters.tag >>
            predicate: ${SBOM_FILE}
            predicate_type: ${PREDICATE_TYPE}
            private_key: << parameters.cosign_private_key >>
            password: << parameters.cosign_password >>
        # 8b. Verify attestation (conditional)
        - when:
            condition: << parameters.verify_attestation >>
            steps:
              - cosign/verify_attestation:
                  image: << parameters.registry >>/<< parameters.registry_namespace >>/<< parameters.image >>:<< parameters.tag >>
                  predicate_type: ${PREDICATE_TYPE}
                  public_key: << parameters.cosign_public_key >>

  # 9. Post-steps hook (user customization)
  - steps: << parameters.post_steps >>

  # 10. Registry logout
  - docker_logout:
      registry: << parameters.registry >>
